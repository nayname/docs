---
title: Advanced Operations
sidebar_label: Advanced Operations
description: Advanced node operations including state sync, snapshots, indexing, and multi-node setups
---

# Advanced Operations

<Callout type="warning">
**Note: This is a conceptual page only and will not be pushed to production in its current state.** 

This page is under development and contains experimental procedures and examples. Feedback is appreciated to help refine and validate these operations before they are considered production-ready.
</Callout>

This guide covers advanced operational procedures for Cosmos EVM nodes including state sync, database backups, transaction indexing, and multi-node test networks.

## State Sync

State sync allows a new node to join the network by fetching a snapshot of the application state at a recent height instead of replaying all blocks from genesis.

### Configuring State Sync

```toml
# config.toml
[statesync]
enable = true
rpc_servers = "https://rpc1.example.com:443,https://rpc1.example.com:443"
trust_height = 0
trust_hash = ""
trust_period = "168h0m0s"
chunk_fetchers = "4"
```

### Finding Trust Height and Hash

```bash
# Get block at specific height from trusted RPC
curl -s https://rpc.example.com/block?height=10000 | \
  jq -r '.result.block_id.hash'

# Get latest block minus 1000 (for safety)
LATEST=$(curl -s https://rpc.example.com/status | jq -r '.result.sync_info.latest_block_height')
TRUST_HEIGHT=$((LATEST - 1000))
TRUST_HASH=$(curl -s "https://rpc.example.com/block?height=$TRUST_HEIGHT" | jq -r '.result.block_id.hash')

echo "trust_height = $TRUST_HEIGHT"
echo "trust_hash = \"$TRUST_HASH\""
```

### State Sync Process

1. **Configure state sync parameters**
2. **Start node** - It will discover and download snapshots
3. **Verify sync** - Node will start from snapshot height

```bash
# Monitor state sync progress
tail -f ~/.evmd/log/evmd.log | grep -E "snapshot|chunk"
```

## Database Snapshots

### Creating Snapshots

Configure automatic snapshots in `app.toml`:

```toml
[state-sync]
snapshot-interval = 1000  # Create snapshot every 1000 blocks
snapshot-keep-recent = 2  # Keep last 2 snapshots
```

### Manual Database Backup

```bash
# Stop node before backup
systemctl stop evmd

# Create compressed backup
tar -czf evmd-backup-$(date +%Y%m%d-%H%M%S).tar.gz \
  ~/.evmd/data \
  --exclude='*.log' \
  --exclude='cs.wal'

# Restart node
systemctl start evmd
```

### Automated Backup Script

```bash
#!/bin/bash
# backup-evmd.sh

BACKUP_DIR="/backup/evmd"
RETENTION_DAYS=7
NODE_HOME="$HOME/.evmd"

# Create backup
systemctl stop evmd
tar -czf "$BACKUP_DIR/evmd-$(date +%Y%m%d-%H%M%S).tar.gz" \
  "$NODE_HOME/data" \
  --exclude='*.log'
systemctl start evmd

# Clean old backups
find "$BACKUP_DIR" -name "evmd-*.tar.gz" -mtime +$RETENTION_DAYS -delete
```

Add to crontab:
```bash
# Daily backup at 3 AM
0 3 * * * /path/to/backup-evmd.sh
```

## Transaction Indexing

### Enable EVM Transaction Indexer

```toml
# app.toml
[json-rpc]
enable-indexer = true
```

### Index Historical Transactions

The `index-eth-tx` command indexes historical Ethereum transactions:

```bash
# Index from latest to earliest (most common)
evmd index-eth-tx backward

# Index from oldest indexed to latest
evmd index-eth-tx forward
```

*Implementation: server/indexer_cmd.go:18-30*

### Custom Indexer Database

```go
// Open indexer database
idxDB, err := OpenIndexerDB(home, backend)
idxer := indexer.NewKVIndexer(idxDB, logger, clientCtx)

// Index specific block
idxer.IndexBlock(block, txResults)
```

## Local Test Networks

### Single Node Development Network

The `local_node.sh` script sets up a single-node development network:

```bash
# Start with default configuration
./local_node.sh

# Overwrite existing data
./local_node.sh -y

# Skip binary installation
./local_node.sh --no-install

# Add extra funded accounts
./local_node.sh --additional-users 5

# Use custom mnemonics
./local_node.sh --mnemonics-input mnemonics.yaml
```

*Implementation: local_node.sh*

### Four-Node Docker Testnet

Using the provided `docker-compose.yml`:

```bash
# Build and initialize 4-node testnet
make localnet-start

# Stop testnet
make localnet-stop
```

This creates a 4-validator network with:
- Nodes on subnet 192.168.10.0/25
- Exposed ports for each node
- Shared volume for configuration

*Implementation: docker-compose.yml, Makefile:357-379*

### Initialize Multi-Node Testnet

```bash
# Initialize 4-validator testnet configuration
evmd testnet init-files \
  --validator-count 4 \
  -o ~/.testnets \
  --starting-ip-address 192.168.10.2 \
  --keyring-backend test \
  --chain-id local-1234 \
  --use-docker true
```

### Custom Docker Compose Setup

```yaml
version: '3.8'
services:
  validator0:
    image: cosmos/evm:latest
    container_name: validator0
    environment:
      - ID=0
    ports:
      - "26656:26656"  # P2P
      - "26657:26657"  # RPC
      - "8545:8545"    # EVM RPC
    volumes:
      - ./node0:/root/.evmd
    command: start
    
  validator1:
    image: cosmos/evm:latest
    container_name: validator1
    environment:
      - ID=1
    ports:
      - "26666:26656"
      - "26667:26657"
      - "8555:8545"
    volumes:
      - ./node1:/root/.evmd
    command: start
```

## Running an IBC Relayer

While the Cosmos EVM supports IBC, relayer configuration depends on your specific setup. Common relayers include:

### Hermes Setup (Example)

```toml
# ~/.hermes/config.toml
[[chains]]
id = 'evmd-1'
type = 'CosmosSdk'
rpc_addr = 'http://localhost:26657'
grpc_addr = 'http://localhost:9090'
gas_price = { price = 0.001, denom = 'aatom' }
```

### Go Relayer Setup (Example)

```bash
# Add chain configurations
rly chains add --file evmd-chain.json
rly chains add --file other-chain.json

# Create path
rly paths new evmd-1 other-1 my-path

# Create connection and channel
rly tx connection my-path
rly tx channel my-path
```

## Node Monitoring

### Prometheus Metrics

Enable metrics collection:

```toml
# app.toml
[telemetry]
enabled = true
prometheus-retention-time = 60

# config.toml
[instrumentation]
prometheus = true
prometheus_listen_addr = ":26660"
```

### Key Metrics Endpoints

```bash
# CometBFT metrics
curl http://localhost:26660/metrics

# EVM metrics (if configured)
curl http://localhost:6065/debug/metrics/prometheus
```

### Health Monitoring Script

```bash
#!/bin/bash
# monitor-node.sh

check_sync() {
  local sync_status=$(curl -s localhost:26657/status | jq -r '.result.sync_info.catching_up')
  if [[ "$sync_status" == "false" ]]; then
    echo "✓ Node is synced"
  else
    echo "⚠ Node is syncing"
  fi
}

check_peers() {
  local peer_count=$(curl -s localhost:26657/net_info | jq -r '.result.n_peers')
  if [[ $peer_count -ge 3 ]]; then
    echo "✓ Connected to $peer_count peers"
  else
    echo "⚠ Low peer count: $peer_count"
  fi
}

check_height() {
  local height=$(curl -s localhost:26657/status | jq -r '.result.sync_info.latest_block_height')
  echo "Block height: $height"
}

check_sync
check_peers
check_height
```

## Database Management

### Database Compaction

```bash
# Compact goleveldb (offline)
evmd compact --home ~/.evmd
```

### Reset State

```bash
# Remove all blockchain data but keep configuration
evmd tendermint unsafe-reset-all --home ~/.evmd

# Also remove address book
rm ~/.evmd/config/addrbook.json
```

### Database Migration

When upgrading database backends:

```toml
# app.toml
app-db-backend = "rocksdb"  # Change from goleveldb

# config.toml
db_backend = "rocksdb"
```

## Performance Profiling

### Enable Profiling

```toml
# app.toml
[json-rpc]
enable-profiling = true

# config.toml
[rpc]
pprof_laddr = "localhost:6060"
```

### Access Profiling Data

```bash
# CPU profile
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# Heap profile
go tool pprof http://localhost:6060/debug/pprof/heap

# Goroutine profile
curl http://localhost:6060/debug/pprof/goroutine?debug=1
```

## Troubleshooting

### Common Issues

#### State Sync Fails
- Verify RPC servers are accessible
- Check trust height is recent (within unbonding period)
- Ensure sufficient disk space for chunks

#### Indexer Out of Sync
```bash
# Re-index from latest backward
evmd index-eth-tx backward
```

#### Database Corruption
```bash
# Last resort - full reset
evmd tendermint unsafe-reset-all
rm -rf ~/.evmd/data/application.db
# Resync from genesis or state sync
```

### Debug Commands

```bash
# Check database integrity
evmd debug raw-store application

# Export state for analysis
evmd export --home ~/.evmd > state.json

# Validate genesis file
evmd validate-genesis --home ~/.evmd
```